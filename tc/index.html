<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📄</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" id="jszip-cdn"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <link rel="stylesheet" href="style/merge.css">
    
    <!-- Modular JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/pdf-handlers.js"></script>
    <script src="js/csv-handlers.js"></script>
    <script src="js/ui-controls.js"></script>
    <script src="js/canvas-system.js"></script>
    <script src="js/main.js"></script>
    
</head>
<body>
    <!-- Image Loading Progress Overlay -->
    <div class="image-loading-overlay" id="imageLoadingOverlay">
        <div class="image-loading-content">
            <div class="image-loading-title">
                <span class="image-loading-spinner"></span>
                Loading Images...
            </div>
            <div class="image-loading-subtitle" id="imageLoadingSubtitle">
                Preparing images for PDF generation
            </div>
            <div class="image-progress-container">
                <div class="image-progress-bar" id="imageProgressBar"></div>
            </div>
            <div class="image-progress-text" id="imageProgressText">0%</div>
        </div>
    </div>


    
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-content">


                <!-- File Uploads -->
                <div class="section">
                    <div class="form-group">
                    <label class="file-input" for="pdfFile">
                        <input type="file" id="pdfFile" accept="application/pdf">
                            <div id="fileLabel">📄 Click to select PDF file</div>
                    </label>
                    </div>
                    
                    <div class="form-group">
                    <label class="file-input" for="csvFile">
                        <input type="file" id="csvFile" accept=".csv,text/csv">
                            <div id="csvLabel">📊 Click to select CSV file</div>
                    </label>
                    </div>
                </div>

                <!-- Add Box Buttons (Above Layout Editor) -->
                <div class="section" style="margin-bottom: 20px;">
                    <div class="box-type-buttons" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="addText()">Add Text Box(es)</button>
                        <button class="btn btn-secondary" onclick="addImagePlaceholder()">Add Image Box(es)</button>
                    </div>
                    
                    <!-- Box Count Selection -->
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Number of Boxes:</label>
                        <select id="boxCountSelect" class="form-control" onchange="updatePageNavigation()">
                            <option value="1" selected>1 Box</option>
                            <option value="2">2 Boxes</option>
                            <option value="3">3 Boxes</option>
                            <option value="4">4 Boxes</option>
                            <option value="5">5 Boxes</option>
                            <option value="6">6 Boxes</option>
                            <option value="8">8 Boxes</option>
                            <option value="10">10 Boxes</option>
                            <option value="12">12 Boxes</option>
                            <option value="15">15 Boxes</option>
                            <option value="20">20 Boxes</option>
                            </select>
                            </div>
                        </div>
                        
                                <!-- Record Info Display -->
        <div id="recordInfoDisplay" class="record-info-display" style="border-top: 1px solid #e9ecef; padding: 14px 16px; background: #ffffff; margin-bottom: 12px; display: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #f0f0f0;">
            <div id="recordInfoText" style="font-size: 14px; color: #2c3e50; font-weight: 600; letter-spacing: 0.2px; text-align: center; width: 100%;">
                No box selected
            </div>
        </div>
                        
                        <!-- Page Navigation -->
                <div id="pageNavigation" class="page-navigation" style="border-top: 1px solid #e9ecef; padding: 12px; background: #f8f9fa; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                        <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary" onclick="previousPage()" style="font-size: 11px; padding: 4px 8px; min-width: 60px;">
                            ← Prev
                                </button>
                        <div style="text-align: center; flex: 1;">
                            <div id="pageInfo" style="font-size: 11px; color: #495057; font-weight: 500;">
                                    Page 1 of 1
                            </div>
                            <div id="pageRecordsInfo" style="font-size: 10px; color: #6c757d;">
                                Records 1-4
                            </div>
                        </div>
                        <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary" onclick="nextPage()" style="font-size: 11px; padding: 4px 8px; min-width: 60px;">
                            Next →
                        </button>
                    </div>
                </div>

                <!-- Compact Layout Editor -->
                <div class="section">
                    <!-- Font Upload -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="font-size: 12px; font-weight: bold; color: #333;">Add Font:</label>
                        <div class="font-upload-area" id="fontUploadArea" style="height: 50px; font-size: 11px; border: 2px dashed #007bff; border-radius: 6px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                            <input type="file" id="fontUploadInput" accept=".ttf,.otf" style="display: none;">
                            <div class="font-upload-content" style="text-align: center;">
                                <p style="margin: 0; font-size: 11px; color: #495057;">Drop TTF/OTF file here or click to browse</p>
                            </div>
                        </div>
                        <div id="fontUploadStatus" class="font-status" style="font-size: 10px;"></div>
                        </div>
                        

                        
                    <!-- CSV Column Selection -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px; font-weight: bold;">CSV Column:</label>
                        <select id="boxColumnSelect" class="form-control" style="font-size: 11px; padding: 4px 8px;">
                                        <option value="">Select CSV column...</option>
                                    </select>
                                </div>
                                
                    <!-- Apply Mode Toggle -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px; font-weight: bold;">Apply To:</label>
                        <div style="display: flex; gap: 4px;">
                            <button type="button" id="applyToAllBtn" class="btn btn-sm btn-outline-secondary" style="flex: 1; font-size: 10px; padding: 4px 6px;" onclick="setApplyMode('all')">All Boxes</button>
                            <button type="button" id="applyToSelectedBtn" class="btn btn-sm btn-primary" style="flex: 1; font-size: 10px; padding: 4px 6px;" onclick="setApplyMode('selected')">Selected Only</button>
                                </div>
                                </div>
                                
                    <!-- Compact Formatting Controls -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px;">Font:</label>
                            <select id="formatAllFontFamily" class="form-control" style="font-size: 11px; padding: 4px 6px;">
                                        <option value="Arial">Arial</option>
                                        <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Courier New">Courier New</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                                    </select>
                                </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px;">Size:</label>
                            <input type="number" id="formatAllFontSize" class="form-control" value="16" min="1" max="72" style="font-size: 11px; padding: 4px 6px;">
                                    </div>
                                </div>
                                
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px;">Color:</label>
                            <input type="color" id="formatAllTextColor" class="form-control" value="#000000" style="height: 30px; padding: 2px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px;">Align:</label>
                            <select id="formatAllTextAlign" class="form-control" style="font-size: 11px; padding: 4px 6px;">
                                        <option value="left">Left</option>
                                        <option value="center" selected>Center</option>
                                        <option value="right">Right</option>
                                <option value="justify">Justify</option>
                                    </select>
                        </div>
                                </div>
                                
                    <!-- Text Style Buttons -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px;">Style:</label>
                        <div style="display: flex; gap: 4px;">
                                            <button type="button" id="formatAllBold" class="btn btn-sm btn-outline-secondary" style="flex: 1; font-size: 10px; padding: 4px 6px;">B</button>
                <button type="button" id="formatAllItalic" class="btn btn-sm btn-outline-secondary" style="flex: 1; font-size: 10px; padding: 4px 6px;">I</button>
                <button type="button" id="formatAllUnderline" class="btn btn-sm btn-outline-secondary" style="flex: 1; font-size: 10px; padding: 4px 6px;">U</button>
                                    </div>
                                </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                                </div>
                            </div>
                            




                <!-- Download Link Section -->
                <div class="download-section" style="border-top: 1px solid #e9ecef; padding: 15px; background: #f8f9fa; margin-bottom: 15px;">
                    <div id="downloadLink" style="display: none;">
                        <a id="downloadAnchor" href="#" target="_blank" class="btn btn-primary" style="text-decoration: none; display: inline-block; width: 100%;">Download Original PDF</a>
                    </div>
                </div>
                            



            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <div class="preview-controls" style="margin-bottom: 15px;">
                    <button id="previewModeBtn" class="btn btn-outline-primary" onclick="togglePreviewMode()" style="font-weight: 500;" title="Toggle Preview Mode - See exactly what your PDF will look like when downloaded (Press P key)">
                        Preview Mode
                    </button>
                </div>
                
                <div class="download-buttons">
                    <button id="screenshotBtn" class="btn btn-primary" onclick="downloadCurrentPdf()">
                        📄 Download Current PDF
                    </button>
                    
                    <button id="downloadPdfsBtn" class="btn btn-success" onclick="downloadPdfs()" disabled>
                        📦 Download All PDFs (ZIP)
                    </button>
                    
                    <button class="btn btn-danger" onclick="deleteSelectedBox()" id="deleteBoxBtn" disabled title="Delete selected box (or press Delete key)">
                        🗑️ Delete
                    </button>
                </div>
            </div>

            <div class="viewer-container">
                <div id="noPdf" class="no-pdf">
                    <h3>No PDF selected</h3>
                    <p>Choose a PDF file to start viewing</p>
                </div>

                <div id="loadingPdf" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading PDF...</p>
                </div>

                <div id="pdfViewer" class="pdf-viewer" style="display: none;">
                    <div class="quality-indicator" id="qualityIndicator" title="PDF is rendered at high resolution for crisp display while maintaining original quality for downloads">High-Quality Preview</div>
                    <div class="zoom-help-indicator" id="zoomHelpIndicator" title="You can add text and image boxes at any zoom level - they will be positioned in the visible area">Zoom-friendly Box Creation</div>
                    <div class="pdf-controls">
                        <button class="pdf-control-btn" onclick="fitToWindow()" title="Fit to Window">⌂</button>
                        <button class="pdf-control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <button class="pdf-control-btn" onclick="zoomOut()" title="Zoom Out">−</button>
                        <button class="pdf-control-btn" onclick="resetView()" title="Reset View">↻</button>
                        <button class="pdf-control-btn" onclick="toggleGrid()" title="Toggle Grid" id="gridBtn">⊞</button>
                        <button class="pdf-control-btn" onclick="togglePDFLock()" title="Toggle PDF Lock" id="pdfLockBtn">🔒</button>
                        <div class="zoom-display" id="zoomDisplay" title="Current Zoom Level">100%</div>
                        <select class="zoom-select" id="zoomSelect" onchange="setZoomLevel(parseInt(this.value))" title="Select Zoom Level">
                            <option value="0">25% - Overview</option>
                            <option value="1">50% - Small</option>
                            <option value="2">75% - Medium</option>
                            <option value="3" selected>100% - Actual Size</option>
                            <option value="4">125% - Large</option>
                            <option value="5">150% - Detail</option>
                            <option value="6">200% - Fine Detail</option>
                            <option value="7">300% - Precision</option>
                        </select>
                    </div>
                    
                                    <div class="pdf-content" id="pdfContent">
                    <div class="grid-overlay" id="gridOverlay"></div>
                    <canvas id="viewer"></canvas>
                    <canvas id="interactionCanvas" class="interaction-canvas"></canvas>
                        <canvas id="editorCanvas" style="display: none;"></canvas>
                    <div id="pdfAreaOutline" class="pdf-area-outline" style="display: none !important;"></div>
                </div>
                </div>
            </div>



            <!-- Editor Properties Sidebar -->
            <div id="editorSidebar" class="editor-sidebar">
                <h4>Object Properties</h4>
                
                <div class="editor-form-group">
                    <label>Bind to CSV Field:</label>
                    <select id="bindField">
                        <option value="">None (Static)</option>
                        <option value="title">Title</option>
                        <option value="subtitle">Subtitle</option>
                        <option value="price">Price</option>
                        <option value="features">Features</option>
                        <option value="image">Image</option>
                    </select>
                </div>

                <div class="editor-form-group">
                    <label>Static Content:</label>
                    <textarea id="staticContent" placeholder="Enter static text content..."></textarea>
                </div>

                <div class="editor-form-group">
                    <label>Position X:</label>
                    <input type="number" id="posX" step="1">
                </div>

                <div class="editor-form-group">
                    <label>Position Y:</label>
                    <input type="number" id="posY" step="1">
                </div>

                <div class="editor-form-group">
                    <label>Width:</label>
                    <input type="number" id="width" step="1">
                </div>

                <div class="editor-form-group">
                    <label>Height:</label>
                    <input type="number" id="height" step="1">
                </div>
            </div>
            
        </div>
    </div>
</body>
</html>